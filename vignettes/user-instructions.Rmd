---
title: "User instructions"

date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{User instructions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Purpose of this package
The ```natronbatchupload``` R-package has been developed for employees at the University Museum of the Norwegian University of Science and Technology (NTNU), and it serves to ease and standardize the process of uploading datasets to the NaTRON database. NaTRON is the internal database for the NTNU University Museum. It stores natural history data, including biodiversity and ecological datasets. NaTRON is therefore different from the MUSIT system which store mostly data on objects in the museum collections. All natural history data to be preserved should be uploaded to the NaTRON database, and the database have a generalized structure in order to support most datatypes (botanical, zoological, collection objects, non-biological environmental data, GIS-data). 

This package was built to import location-event data, and is in its current version not designed for large datasets containing repeated measurements (e.g data from dataloggers, biotelemetric studies etc.).

## Workflow
The process of uploading data to NaTRON using natronbatchupload consist of five steps:

- **Step 1. Restructure your dataset from wide to long format**
- **Step 2. Establish connection to NaTRON database** 
- **Step 3. Check for pre-existing localities in NaTRON**: 
- **Step 4. Upload new locations to NaTRON**: *Locations* are places and this datatable include information about physical places that do not change year to year (typically place names and coordinates). This step uploads new locations that are not pre-existing on NaTRON. All locations must be present on NaTRON before the 'real data' is uploaded and you will not be able to upload event-data that don't have a corresponding *locationID* in the database. The link between the 'real data' (ie event data or occurence data) and the location specific metadata is ensured by the relational nature of NaTRON. 
- **Step 5. Structure event data**: This step organises your event data table to be compatible and ready to upload to NaTRON. The event data table needs to look just like the NaTRON format, eg the columns in the same order etc. This step include fetching and attaching the correct *locationID* from the locations datatable.
- **Step 6. Upload event data to NaTRON**: This step uploads your structured event data table to NaTRON. For occurence datasets you may want to skipp this and the preceeding step.
- **Step 7. Structure occurence data**: This step organises your occurrence data table to be compatible and ready to upload to NaTRON.
- **Step 8. Upload occurrence data to NaTron**: This step uploads your structured event data table to NaTRON.


## Step 1. Restructure
The first step to getting your data on to NaTRON is to restructure the dataset from wide to long format to be compatible with the functions in the ```natronbatchupload``` R-package. Most datasets are punched in Excel in a wide format (ie lots of columns and few rows; see examples at the bottom of this vignette), but NaTRON and most other databases prefer the long format. This step is not covered by this package and must be done manually. We recoment looking into ```reshape2``` and ```dplyr``` for this type of data wrangling. 




## Step 2. Establish a connection to the NaTRON database
Using the `natron_connect` function makes it easy to connect to NaTRON in R. The functions takes one argument -- your user name. A pop-up window will appear where you are asked for your password. Save your connection to the environment so that it can be used in subsequent functions. Example of use:

```{r, eval=FALSE}
myConnection <- natron_connect(username)

``` 
Talk to Marc Daverdin about NaTRON access. 

## Step 3. Check for pre-existing localities in Natron:
To prevent duplicate in the NaTRON locality table you are asked to use locations already present in the database if possible.
This step scans NaTRON for locations that are identical to, or within a given radius if, the locations in the dataset that is to be uploaded. Set the radius in meters:

```{r, eval=FALSE}
radius <- 8000 #setting it very high here just to make a point

``` 


If ```location_check()``` returns matching locations that already exists in NaTRON, ```get_new_loc()```  will let you choose whether to use these preexisting locations and their unique *locationID*. This makes updating time series data much more standardised.



###The `location_check` function have three parameters:

- The `flatt_data` parameter specify the dataset to be checked for pre-existing localities in the NaTRON database.
- The `conn` parameter specify the NaTRON connection (look at the paragraph "How to connect to NaTRON with R").
- The `radius` parameter specify the radius (in meters) that will be used to scan for pre-excisting localities in NaTRON (based on coordinates).


#Load the dataset to be uploaded to NaTRON into R
library(readr)
flat_data_dummy_std_long <- read_csv("flat_data_dummy_std_long.csv")

#Run the `location_check` function
location_check(flatt_data=flat_data_dummy_std_long, conn=Myconnection, radius=8000)

``` 


**After running the `location_check` function, you must manully check if some of the localities in the list of pre-existing localities from the NaTRON database can be reused. If so, you must copy-paste the locationID from the pre-existing NaTron locality in the locality list produced by `location_check`.**



##4. Upload new locations to NaTRON
The `f_upsert_location` function will let you oppload new locations to the NaTRON database. The format of the data to be uploaded must be at the exact same format as the NaTRON database table (see included example dataset `dummy_locationTable`).

###The `f_upsert_location` function have two parameters:

- The `locations` specify the data table containing locations to be uploaded to NaTRON.
- The `con` parameter specify connection object with write permissions.



```
#Load dataframe with localities to be uploaded to NaTRON
library(readr)
My_updated_location_table <- read_csv("dummy_locationTable.csv")
View(My_updated_location_table)

#Run the f_upsert_location function
f_upsert_location(locations=My_updated_location_table, con=Myconnection)
```

##4. Structure event-data


The `f_structure_and_map_event` function takes inn a flattended datatable with both terms/colums and data types corresponding exactly to the database and returns an event dataframe ready to be upserted.

###The `f_structure_and_map_event` function have three parameters:

- The `flatt_data` specify the data table to be structured and prepared for upload to NaTRON.
- The `conn` parameter specify connection object with write permissions.
- The `location_table` parameter specify the location table for the flattened data.


```
#Load flattened dataset into R.
library(readr)
flat_data_dummy_std_long <- read_csv("flat_data_dummy_std_long.csv")
View(flat_data_dummy_std_long)

#Load the location table (that have been made and uploadet to NaTron in step 3)
My_updated_location_table <- read_csv("dummy_locationTable.csv")
View(My_updated_location_table)

#Run the f_structure_and_map_event function
My_event_data <- f_structure_and_map_event(flatt_data=flat_data_dummy_std_long, conn=Myconnection, location_table=My_uptdated_location_table)
View(My_event_data)
```

##6. Upload structured event data to NaTron:

The `f_upsert_event` function uploads your structured event data-frame from step 5.

###The `f_upsert_event` function have two parameters:

- The `event_data` specify the event data frame to be uploaded to NaTRON.
- The `con` parameter specify connection object with write permissions.

```
f_upsert_event(event_data=My_event_data, con=Myconnection)
```


##7. Structure occurrence-data


The `f_structure_and_map_occurence` function takes inn a flattended datatable with both terms/colums and data types corresponding exactly to the database and returns an occyrence dataframe ready to be upserted.

###The `f_structure_and_map_occurence` function have three parameters:

- The `flatt_data` specify the flattened data table to be structured and prepared for upload to NaTRON.
- The `conn` parameter specify connection object with write permissions.
- The `location_table` parameter specify the location table for the flattened data.


```
#Load flattened dataset into R.
library(readr)
flat_data_dummy_std_long <- read_csv("flat_data_dummy_std_long.csv")
View(flat_data_dummy_std_long)

#Load the location table (that have been made and uploadet to NaTRON in step 3)
My_updated_location_table <- read_csv("dummy_locationTable.csv")
View(My_updated_location_table)

#Run the f_structure_and_map_event function
My_occurrence_data <- f_structure_and_map_occurrence(flatt_data=flat_data_dummy_std_long, conn=Myconnection, location_table=My_uptdated_location_table)
View(My_occurence_data)
```

##8. Upload structured event data to NaTRON:

The `f_upsert_occurrence` function uploads your structured occurence data-frame from step 7.

###The `f_upsert_occurrence` function have two parameters:

- The `occurrence_data` specify the event data frame to be uploaded to NaTRON.
- The `con` parameter specify connection object with write permissions.

```
f_upsert_occurrence(event_data=My_occurrence_data, con=Myconnection)
```

## Examples of stylized data tables

#### *Example of wide data*

| Sampling date    | Sampling locations  | Alchemilla alpina   | Agrostis cappilaris | Andromeda polifolia |
| :-------------:  | :-------------:     | :-------------:     |:-------------:      | :-----:             |
| 2010             | A                   | 12                  | 6                   | 2                   |
| 2011             | A                   | 3                   | 17                  | 4                   |
| 2011             | B                   | 15                  | 2                   | 6                   |


#### *Example of long data*

| Sampling event    | Sampling date        | Sampling location   | Species       |      |  Quantity           |
| :-------------:   | :-------------:      |:-------------:      | :-------------:      |:-------------:      |
| 1                 | 2010                 |A                    |Alchemilla alpina    | 12                  |
| 1                 | 2010                 |A                    |Agrostis cappilaris  | 6                   |
| 1                 | 2010                 |A                    |Andromeda polifolia  | 2                   |
| 2                 | 2011                 |A                    |Alchemilla alpina    | 3                   |
| 2                 | 2011                 |A                    |Agrostis cappilaris  | 17                  |
| 2                 | 2011                 |A                    |Andromeda polifolia  | 4                   |
| 3                 | 2011                 |B                    |Alchemilla alpina    | 15                  |
| 3                 | 2011                 |B                    |Agrostis cappilaris  | 2                   |
| 3                 | 2011                 |B                    |Andromeda polifolia  | 6                   |

#### *Example of location table*

| locationID        | Sampling location | Coordinates 
|:-------------:    |:-------------:    |:-------------:
|a                  |A                  | x.xx 
|a                  |A                  | x.xx
|a                  |A                  | x.xx
|a                  |A                  | x.xx
|a                  |A                  | x.xx
|a                  |A                  | x.xx
|b                  |B                  | x.xx
|b                  |B                  | x.xx
|b                  |B                  | x.xx


#### *Example of event table*

| eventID    | Sampling event    | Sampling date        | locationID   |     
| :-------------:   | :-------------:   | :-------------:      |:-------------:     
| 1*                 | 1                 | 2010                 |a                   
| 1*                 | 1                 | 2010                 |a                   
| 1*                 | 1                 | 2010                 |a                   
| 2*                 | 2                 | 2011                 |a                   
| 2*                 | 2                 | 2011                 |a                   
| 2*                 | 2                 | 2011                 |a                   
| 3*                 | 3                 | 2011                 |b                   
| 3*                 | 3                 | 2011                 |b                   
| 3*                 | 3                 | 2011                 |b                   


#### *Example of occurence table*

| eventID           | Species       |      |  Quantity           |
| :-------------:   | :-------------:      |:-------------:      |
| 1*                |Alchemilla alpina    | 12                  |
| 1*                |Agrostis cappilaris  | 6                   |
| 1*                |Andromeda polifolia  | 2                   |
| 2*                |Alchemilla alpina    | 3                   |
| 2*                |Agrostis cappilaris  | 17                  |
| 2*                |Andromeda polifolia  | 4                   |
| 3*                |Alchemilla alpina    | 15                  |
| 3*                |Agrostis cappilaris  | 2                   |
| 3*                |Andromeda polifolia  | 6                   |


